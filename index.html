<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First-Person Weapon Viewer</title>
    <!-- Load Three.js core library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load GLTFLoader to handle .glb files -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        /* General styling for the full-screen canvas */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            /* Create a simple sky gradient background */
            background: linear-gradient(to bottom, #87ceeb 0%, #ffffff 70%);
        }
        canvas {
            display: block;
        }

        /* Styling for the loading message and switch button */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through by default */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Align elements to the bottom */
            padding-bottom: 20px;
            z-index: 10;
        }
        
        #loading-message {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.2em;
            pointer-events: auto;
            margin-bottom: 10px;
        }

        #switch-button {
            pointer-events: auto; /* Make the button clickable */
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s, transform 0.1s;
        }

        #switch-button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="loading-message">Loading models...</div>
        <button id="switch-button" style="display: none;">Switch Weapon (Axe)</button>
    </div>
    
    <script type="module">
        // Import necessary components from the global THREE object
        const { 
            Scene, PerspectiveCamera, WebGLRenderer, DirectionalLight, HemisphereLight, 
            GLTFLoader, Clock, Group 
        } = THREE;

        // Global variables
        let scene, camera, renderer, loader;
        let weaponGroup; // Group to hold the current weapon model
        let currentModelName = 'BattleAxe';
        let models = {}; // Object to store loaded model data: { 'BattleAxe': gltfScene, 'Sword': gltfScene }
        let isLoaded = false;
        
        const loadingMessage = document.getElementById('loading-message');
        const switchButton = document.getElementById('switch-button');
        const clock = new Clock();

        // 1. Initialization
        function init() {
            // Scene setup
            scene = new Scene();

            // Camera setup (First-Person Perspective)
            // FOV, Aspect Ratio, Near, Far clipping plane
            camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            // Position the camera slightly up, mimicking eye level
            camera.position.set(0, 1.6, 0); // Camera at (0, 1.6, 0) - average human height

            // Weapon Group: This group is attached to the camera and holds the weapon
            weaponGroup = new Group();
            camera.add(weaponGroup);
            scene.add(camera); // Add camera (and its children) to the scene

            // Renderer setup
            renderer = new WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // Enable physically correct lighting for professional shading
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0; 
            renderer.outputEncoding = THREE.sRGBEncoding;
            
            document.body.appendChild(renderer.domElement);

            // 2. Lighting Setup (Brightly Shaded and Nice)
            
            // Hemisphere Light: Provides soft ambient light, simulating sky and ground reflection
            const hemiLight = new HemisphereLight(0xffffff, 0x444444, 0.8);
            hemiLight.position.set(0, 50, 0);
            scene.add(hemiLight);

            // Directional Light: Simulates the sun, creating strong highlights and shadows
            const dirLight = new DirectionalLight(0xffffff, 1.5); // Brighter light
            dirLight.position.set(5, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            dirLight.shadow.camera.near = 0.5;
            dirLight.shadow.camera.far = 50;
            scene.add(dirLight);

            // Add a simple ground plane (optional, but good for context)
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshStandardMaterial({ color: 0x666666 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Enable shadow map for the renderer
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows

            // 3. Load Models
            loader = new GLTFLoader();
            loadModel('BattleAxe.glb', 'BattleAxe');
            loadModel('Sword.glb', 'Sword');
        }

        // Function to handle GLB loading
        function loadModel(filePath, name) {
            loader.load(
                filePath,
                function (gltf) {
                    // Traverse and enable shadow casting/receiving
                    gltf.scene.traverse(function (child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = false;
                        }
                    });

                    models[name] = gltf.scene;

                    // Initial attachment for the first model loaded
                    if (Object.keys(models).length === 2) {
                        isLoaded = true;
                        loadingMessage.style.display = 'none';
                        switchButton.style.display = 'block';
                        // Attach the initial model (BattleAxe)
                        attachWeapon('BattleAxe');
                    }
                },
                // Progress Callback
                function (xhr) {
                    const percent = Math.round(xhr.loaded / xhr.total * 100);
                    // Only update loading message if we haven't loaded everything yet
                    if (Object.keys(models).length < 2) {
                        loadingMessage.textContent = `Loading ${name}: ${percent}%`;
                    }
                },
                // Error Callback
                function (error) {
                    console.error(`An error occurred while loading ${name}:`, error);
                    loadingMessage.textContent = `Error loading ${name}. Check console.`;
                }
            );
        }

        // Function to attach and position the weapon in first-person view
        function attachWeapon(name) {
            // 1. Clear the weaponGroup
            while(weaponGroup.children.length > 0){
                weaponGroup.remove(weaponGroup.children[0]);
            }

            const modelScene = models[name];
            
            // 2. Set the transform for first-person hold
            // These values are often found by trial and error for a good 'hold' feeling
            modelScene.rotation.set(0, Math.PI / 2, 0); // Rotate to face forward
            modelScene.position.set(0.6, -0.6, -1.0); // Offset to lower-right in front of the camera
            modelScene.scale.set(1.5, 1.5, 1.5); // Scale up for better visibility
            
            weaponGroup.add(modelScene);
            currentModelName = name;
            switchButton.textContent = `Switch Weapon (${name === 'BattleAxe' ? 'Sword' : 'Axe'})`;
        }
        
        // 4. Handle Weapon Switching
        switchButton.addEventListener('click', () => {
            if (!isLoaded) return;
            const nextWeapon = currentModelName === 'BattleAxe' ? 'Sword' : 'BattleAxe';
            attachWeapon(nextWeapon);
        });

        // 5. Animation Loop (Main Game Loop)
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            // Optional: Add a slight bobbing/breathing animation for the weapon
            if (isLoaded) {
                const time = clock.getElapsedTime();
                weaponGroup.position.y = Math.sin(time * 3) * 0.01;
                weaponGroup.rotation.z = Math.sin(time * 2) * 0.005;
            }

            renderer.render(scene, camera);
        }

        // 6. Handle Window Resize
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // Initialize Three.js and start the loop when the window loads
        window.onload = function() {
            init();
            animate();
        };

    </script>
</body>
</html>